---
title: "LoRaWAN の基礎：IoT 通信の長距離・低消費電力を支える技術"
date: "2025-05-27"
tags: ["IoT"]
summary: "LoRaWAN は、低消費電力かつ干渉に強い長距離通信を実現する無線通信プロトコルです。この記事では、LoRaWAN の基本的な概念、通信方式、セキュリティ、およびベストプラクティスについて解説します。"
thumbnail: "/images/lorawan_fundamentals.webp"
---

> **TL;DR**
> IoT の基礎を学ぶために、まずは LoRaWAN の基礎を学ぶことにした。
> LoRaWAN は、低消費電力かつ干渉に強い長距離通信を実現する無線通信プロトコルであり、IoT デバイスの通信に広く利用されている。
> この記事では、LoRaWAN の基本的な概念、通信方式、セキュリティ、ベストプラクティスについて学んだ内容をまとめる。

<br />

## LoRa、LoRaWAN とは

LoRa(Long Range)は、低消費電力で長距離通信を可能にする無線通信技術である。
LoRaWAN は、LoRa をベースにしたネットワークプロトコルであり、そのエネルギー効率と柔軟性から IoT デバイスの通信に広く利用されている。

<br />

## LoRa における通信方式

LoRa では、**Chirp Spread Spectrum (CSS)**という技術を使用することで、干渉に強い長距離通信を実現している。
より具体的に、CSS は別名**Spread Spectrum Modulation** とも呼ばれ、周波数を線形に上昇させたり下降させたりすることで、信号を広い帯域に分散させる。
このように広く分散させることで信号ごとに特徴的なパターンを示すので、干渉に強くなる。
また、LoRa は電磁波のドップラー効果にも耐性があることが知られている。

さらに、この仕組みはシンプルなのでデバイスとゲートウェイの間で同じ仕組みでの通信が可能である。
特に、デバイスからゲートウェイへの通信は**Uplink**と呼ばれ、逆向きの通信は**Downlink**と呼ばれる。

<br />

### Spreading Factor (SF)

**Spreading Factor (SF)** は、LoRa の通信において重要なパラメータであり、データの送信レートを制御する。
より公式的な定義では、SF は、1 シンボルあたりのビット数を表す。
そのため、SF が大きいほど、ビットレートは小さくなるので、通信速度も遅くなる上、長時間通信するので消費電力も大きくなる。
一方で、SF が大きいほど、より広い帯域で信号を送信できるため、長距離通信が可能になる。

| SF   | 通信速度 | 通信距離 | 消費電力 |
| ---- | -------- | -------- | -------- |
| 高い | 遅い     | 長い     | 高い     |
| 低い | 速い     | 短い     | 低い     |

### Adaptive Data Rate (ADR)

SF は通信効率と消費電力のトレードオフを制御する重要なパラメータなので、LoRaWAN では**Adaptive Data Rate (ADR)**というアルゴリズムがよく利用される。
ADR は、ネットワークの状態、特にシグナルノイズ比 (Signal-to-Noise Ratio, SNR) と通信品質を考慮して、デバイスの SF を動的に調整する。
これにより、デバイスは最適な SF を選択し、通信の効率と消費電力を最適化できる。

### LoRa が他の通信方式に比べてエネルギー効率が良い理由

無線通信では空気中を電磁波が伝播するため、信号が減衰する。
この信号の減衰は**Free Space Path Loss (FSPL)**と呼ばれ、次の式で表される。

$$
FSPL = 20 \log_{10}(通信距離) + 20 \log_{10}(周波数) + K
$$

FSPL を使うと、受信側で受け取るエネルギー量を以下のように定量的に評価できる。

$$
受信エネルギー = 送信エネルギー - FSPL + 送受信アンテナゲイン + その他の損失
$$

無線通信では受信側が受け取ったエネルギー量は受信側の受信感度よりも大きくならなければならない。
したがって、その受信エネルギーと受信感度の差は通信の余裕度を表し、**Link Budget**と呼ばれる。
Link Budget が大きいということは、その通信がより安定していることを意味する。

一般に、受信感度は通信方式によって決まる。
特に、同じ Link Budget の条件下で、LoRa は他の通信方式、例えば Wi-Fi や Narrowband IoT (NB-IoT) に比べて、より低い受信感度を持つ。
そのため、LoRa は信号の減衰が大きい長距離通信においても、より少ないエネルギーで安定した通信を実現できる。

### 障害物による減衰

LoRa の通信距離は理論上では最大で 850 km に達するが、現実には地形や建物などの障害物による減衰や反射・散乱、フレネルゾーン効果などの影響を受けるため、5-10km 程度である。
科学的な調査によると、SF がより大きい条件では、LoRa のパフォーマンスが向上することが示されている。

このように、電磁波は様々な要因によって減衰するため、ゲートウェイを適切に配置することが重要である。
例えば以下のような目安がある。
| 条件 | 通信距離 |
| ---- | -------- |
| 屋内 | < 0.5 km |
| 屋外、家屋屋根上 | 1-2 km |
| 屋外、高い建物屋上 | > 10 km |

### LoRa の制限

各地域ごとに LoRa 通信には一定の制限が設けられている。

特に日本では以下の内容に注意する必要が有る。

- 最大滞留時間(dwell time, 信号を連続して送信する時間)は 400 ms
- LBT(Listen Before Talk, 送信前にチャネルが利用可能か確認する仕組み)の実装が必要
- Duty Cycle(チャネルの使用率)には特に制限はない

<br />

## LoRaWAN の種類

LoRaWAN は、デバイスとゲートウェイの間の通信を管理するためのプロトコルであり、以下の 3 つのクラスに分類される。

| クラス  | 電力消費 | レイテンシー | 特徴                                                                               | 例                             |
| ------- | -------- | ------------ | ---------------------------------------------------------------------------------- | ------------------------------ |
| Class A | 低い     | 高い         | 送信はデバイスからのみ開始され、ネットワークはデバイスからの送信後にのみ応答する。 | センサーなどのパルス通信       |
| Class B | 中程度   | 中程度       | 送信はデバイスからか開始されるか、一定間隔でネットワークから開始される。           | ビーコンなどの定期的な通信     |
| Class C | 高い     | 低い         | 送信はネットワークから開始され、デバイスは常に送信をリッスンする。                 | 街灯制御などのリアルタイム通信 |

LoRaWAN では、送信ペイロードのサイズは 51-222 バイトくらい、データレートは例えば 125kHz の帯域幅で最大 5.5 kbps のように制限されている。
そのため、通信の際にはデータの圧縮や効率的なパケット設計が重要である。
ただし、この制限は地域によって異なるため、使用する地域の規制に従う必要がある。
また、一般に Uplink の方が Downlink よりも通信容量が大きいため、通信が非同期的であることにも注意が必要である。

<br />

## LoRaWAN のセキュリティ

LoRa では物理層でのセキュリティは提供されないため、LoRaWAN を使用することでセキュリティを確保する必要がある。

### LoRaWAN セッション

LoRaWAN では、以下の 3 つの観点でのセキュリティメカニズムが提供されている。

| 観点                        | 説明                                                     |
| --------------------------- | -------------------------------------------------------- |
| **認証(Authenticity)**      | ネットワークがデバイスを識別して通信を許可するための認証 |
| **完全性(Integrity)**       | 中間経路上での改ざんを防ぐためのメカニズム               |
| **機密性(Confidentiality)** | データは暗号化され、ネットワーク内でのデータの盗聴を防ぐ |

とくに各セッションで以下のようにネットワーク層とアプリケーション層でのセキュリティが提供されている。

| 層                 | 担保する観点 | キーコンポーネント                                                                                                                                       |
| ------------------ | ------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ネットワーク層     | 認証、完全性 | DevAddr(デバイスアドレス)、NwkSKey(ネットワークセッションキー)<br/>FCntUp、FCntDown(フレームカウンター)<br/>Mac ステート(チャネル、データレート、etc...) |
| アプリケーション層 | 機密性       | AppSKey(アプリケーションセッションキー)<br/>FCntUp、FCntDown                                                                                             |

LoRaWAN では暗号化に AES 暗号を使用しており、ネットワーク層とアプリケーション層でそれぞれ異なるキーを使用する。
そのため、セッション中はそれぞれのセッションキーは固定される。
また、各フレームカウンターは送受信ごとにインクリメントされる。

また、物理層でセキュリティがないので以下のメタデータは常に公開されていることに注意。

| メタデータ名    | 説明                           |
| --------------- | ------------------------------ |
| JoinEUI(AppEUI) | Join サーバーへのポインター    |
| DevEUI          | デバイスの識別子               |
| DevAddr         | デバイスのアドレス             |
| FCntUp,FCntDown | フレームカウンター             |
| ポート番号      | アプリケーション層のポート番号 |
| ペーロード長    | ペイロードの長さ               |
| MAC コマンド    | MAC コマンドの種類と内容       |

### セッションプロトコル

LoRaWAN では以下の 2 つのプロトコルが一般的である。

| プロトコル名                           | 説明                                                                                                                                               | 特徴                                                                                                                                 |
| -------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| **OTAA(Over-The-Air Activation)**      | セッション開始時にデバイスがネットワークに参加する手続きを行う<br/>参加時にルートキーからセッションキーを生成し、ネットワークが DevAddr を発行する | リキーイングが可能<br/>デバイスはあらゆるネットワークに参加可能<br/>セキュリティが高い                                               |
| **ABP(Activation By Personalization)** | デバイスが事前に設定された DevAddr とセッションキーを使用してネットワークに参加する<br/>ネットワークを事前設定する必要があり、セッションキーは固定 | デバイスは特定のネットワークにのみ参加可能<br/>セッションキーが固定されているため、セキュリティが低い<br/>ディスクサイズを節約できる |

特に制限がなければ、OTAA を使用することが推奨される。

セッションキー生成で使用されるルートキーは一般にデバイスを製造する際に信頼できる Join Server からプロビジョンされる。
そのため、**ルートキーを第三者に共有したり、再利用したりしない**ことが重要。

### バージョンごとのセッションキー

LoRaWAN には現在 1.0 系と 1.1 系の 2 つのバージョンが存在する。
それぞれのバージョンでは以下のように生成されるセッションキーが異なる。

| バージョン | ルートキー | セッションキー                       |
| ---------- | ---------- | ------------------------------------ |
| 1.0.x      | AppKey     | AppSKey, NwkSKey                     |
| 1.1.x      | AppKey     | AppSKey                              |
|            | NwkKey     | FNwkSIntKey, SNwkSIntKey, NwkSEncKey |

1.1 系では、ネットワークセッションキーが 3 つに分割されており、それぞれ FNwkSIntKey(Forwarding Network Session Integrity Key) と SNwkSIntKey(Serving Network Session Integrity Key) は安全性チェックに、NwkSEncKey(Network Session Encryption Key) は暗号化に使用される。

1.1 系はよりセキュアであるが、2025 年 5 月時点では残念ながらそこまで普及していない。

### その他の機能

LoRaWAN では他にも以下のようなセキュリティ機能が提供されている。

- 通信の品質や可用性をチェックするための MAC コマンド
- メッセージが届いたかどうかを確認するための機構
- レプレイ攻撃(すでに受信されたメッセージを再度送信する攻撃)を防ぐためのフレームカウンター
- 各参加試行を一意に識別するための DevNounce

<br />

## LoRaWAN でのベストプラクティス

LoRaWAN 通信でのパフォーマンスを向上させるためには、以下のようなベストプラクティスがある。

- 各デバイスを LoRaWAN の仕様に従って正しく実装する。
- できるだけ OTAA を使用する。
- 不必要な参加リクエストを避ける。
- デバイスの送信頻度を適切に設定する。
- 送信ペイロードはできる限り小さくする。
- パケットロスが避けられないことに注意する。
- 各デバイスの送信タイミングを同期させない。特に 00:00 のような固定のタイミングで送信しない。
- デバイスが固定されている場合は ADR を使用して、デバイスの SF を自動で調整する。
- デバイスの永続化メモリを使用して、セッションキーやフレームカウンター、DevNounce などの状態を保存する。
- 3 つ程度以上の確認応答がロストして始めて通信ロストを想定する。1 回の応答ではデバイスが機能しない可能性がある。

<br />

## まとめと所感

LoRa は Chirp Spread Spectrum (CSS)を使用して長距離通信を実現する無線通信技術であり、低エネルギー消費と高い耐障害性が特徴である。
一方で、物理レイヤーではセキュリティが提供されないため、LoRaWAN プロトコルを使用してセキュリティを確保する必要がある。
特に、OTAA でのネットワーク参加プロセスによるセッション管理が一般的であり、認証、完全性、機密性の観点からセキュリティが提供される。
LoRaWAN では、小さなデータパケットを長距離通信することを念頭に置いて実装することが重要であり、地域ごとに Dwell Time や Duty Cycle の制限があることに注意する必要がある。

LoRaWAN の学習を通じて、LoRaWAN 通信の最低限の知識は得られたと思う。
今後は、個々のセンサーやゲートウェイの実装などより踏み込んだ学習を進めていき、実際に LoRaWAN を使った IoT システムを構築していきたい。

<br />

## 参考文献

- [LoRaWAN Fundamentals](https://www.udemy.com/course/lorawan-fundamentals/)
